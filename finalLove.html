<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;600&display=swap"
      rel="stylesheet"
    />
    <link href="css/main.css" rel="stylesheet" />
  </head>

  <body>
    <!-- <audio autoplay="autopaly">
      <source src="renxi.mp3" type="audio/mp3" />
    </audio> -->
    <!-- 星空html -->
    <!-- <div> -->

    <div class="container2">
      <div class="content">
        <canvas id="universe"></canvas>
      </div>
    </div>

    <!-- </div> -->
    <div class="title">
      <!-- EDIT HERE -->
      <h3 class="STARDUST1">08/2025</h3>
      <h1 class="STARDUST2">TheKhang &amp; VuongThao</h1>
      <h3 id="pinkboard2" class="STARDUST3">
        L O V E <strong>❤</strong> Y O U
      </h3>
      <canvas id="pinkboard"></canvas>

      <div class="line">❤️ Anh thương bxa nhiều lắm</div>
      <div class="line">❤️ Cùng nhau cố gắng yêu thương chăm sóc nhau nhé</div>
      <div class="line">❤️ Tha thứ những lỗi lầm của anh nhaaaaaa</div>
      <div class="line">
        ❤️ Hi vọng ngày mai của ngày sau trời sẽ sáng rực rỡ
      </div>
      <div class="line">❤️ Dẫn lối cho hai đứa đến cùng một gia đình</div>
      <div class="line">❤️ Mọi thứ đều sẻ chia với nhau</div>
      <div class="line">❤️ Và</div>
      <div class="line">❤️ Vẫn giữ được sự ấm áp dành cho nhau</div>
      <div class="line">❤️ Từ những cái ôm</div>
      <div class="line">❤️ Nụ hôn</div>
      <div class="line">❤️ Lời nói</div>
      <div class="line">❤️ Yêu Em Rất Nhiều</div>
      <div class="line">❤️ Vương Thảo</div>
      <div class="gallery">
        <img src="images/1.jpg" alt="" />
        <img src="images/5.jpg" alt="" />
        <img src="images/7.jpg" alt="" />
        <img src="images/10.jpg" alt="" />
        <img src="images/9.jpg" alt="" />
        <img src="images/8.jpg" alt="" />
      </div>

      <div class="final-video">
        <video id="love-video" autoplay muted playsinline>
          <source src="images/loveVideo.mp4" type="video/mp4" />
          Trình duyệt không hỗ trợ video.
        </video>
      </div>

      <div id="lyrics"></div>
    </div>
    <audio id="bg-music" loop>
      <source src="audio/Sau Tất Cả.mp3" type="audio/mpeg" />

      Trình duyệt của bạn không hỗ trợ phát nhạc.
    </audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/particle.js"></script>
    <script src="js/universe.js"></script>
    <script>
      // ===== PHASE ELEMENTS =====
      const lines = document.querySelectorAll(".line");
      const gallery = document.querySelector(".gallery");
      const galleryImgs = document.querySelectorAll(".gallery img");
      const finalVideoWrap = document.querySelector(".final-video");
      const video = document.getElementById("love-video");
      const lyricsDiv = document.getElementById("lyrics");
      const bgMusic = document.getElementById("bg-music");

      // Nếu cần một click để “mở khóa” autoplay trên iOS
      // (nhạc sẽ phát khi user ấn đâu đó lần đầu)
      document.body.addEventListener(
        "click",
        () => {
          bgMusic.play().catch(() => {});
        },
        { once: true }
      );

      // ===== PHASE 1: LINES =====
      let lineIndex = 0;

      function showLine() {
        // Ẩn tất cả dòng
        lines.forEach((line) => {
          line.classList.remove("show");
          line.style.display = "none";
        });

        // Nếu còn dòng thì show
        if (lineIndex < lines.length) {
          const current = lines[lineIndex];
          current.style.display = "block"; // cần để element hiện thì mới thấy hiệu ứng
          setTimeout(() => current.classList.add("show"), 50); // delay nhẹ để transition ăn

          lineIndex++;
          setTimeout(showLine, 3000); // dòng tiếp theo
        } else {
          // Hết tất cả
          setTimeout(() => {
            lines.forEach((line) => {
              line.classList.remove("show");
              line.style.display = "none";
            });
            showGallery(); // sang gallery
          }, 1200); // fade-out nhẹ
        }
      }

      // ===== PHASE 2: GALLERY =====
      function showGallery() {
        gallery.style.display = "block";
        galleryImgs.forEach((img, i) => {
          setTimeout(() => {
            img.classList.add("show");
            // ảnh cuối cùng xong -> qua video
            if (i === galleryImgs.length - 1) {
              setTimeout(showFinalVideo, 1500);
            }
          }, i * 1200); // nhịp giữa các ảnh
        });
      }

      // ===== PHASE 3: VIDEO =====
      function showFinalVideo() {
        gallery.style.display = "none";

        finalVideoWrap.style.display = "block";
        // Autoplay video (muted/playsinline đã set trong HTML)
        video.play().catch(() => {});
        // Khi video chạy xong -> ẩn gallery + video, show lyrics
        video.onended = () => {
          gallery.style.display = "none";
          finalVideoWrap.style.display = "none";
          // Chuyển qua lyrics
          showLyrics();
        };
      }

      // ===== PHASE 4: LYRICS (đồng bộ với bgMusic) =====
      async function showLyrics() {
        lyricsDiv.style.display = "block";
        await bgMusic.play().catch(() => {});

        const lrcText = await fetch("song.lrc")
          .then((r) => r.text())
          .catch(() => "");
        const lyricsData = parseLRC(lrcText);

        lyricsDiv.innerHTML = "";

        let currentIdx = 0;

        bgMusic.currentTime = 0;
        bgMusic.addEventListener("timeupdate", () => {
          const t = bgMusic.currentTime;

          // nhảy tới lyric hiện tại
          while (
            currentIdx < lyricsData.length - 1 &&
            t >= lyricsData[currentIdx + 1].time
          ) {
            currentIdx++;
          }

          // xoá lyric cũ và render 5 dòng gần nhất
          lyricsDiv.innerHTML = "";
          const start = Math.max(0, currentIdx - 2); // lùi lại 2 dòng
          const end = Math.min(lyricsData.length, currentIdx + 3); // +2 dòng kế tiếp
          for (let i = start; i < end; i++) {
            const p = document.createElement("p");
            p.textContent = lyricsData[i].text || " ";
            if (i === currentIdx) p.classList.add("active");
            lyricsDiv.appendChild(p);
          }
        });
      }

      // ===== LRC Parser =====
      function parseLRC(lrcText) {
        if (!lrcText) return [];
        const lines = lrcText.split(/\r?\n/);
        const re = /\[(\d{2}):(\d{2}\.\d{2})\](.*)/;
        const out = [];
        for (const line of lines) {
          const m = line.match(re);
          if (!m) continue;
          const min = parseInt(m[1], 10);
          const sec = parseFloat(m[2]);
          const time = min * 60 + sec;
          const text = (m[3] || "").trim();
          if (text) out.push({ time, text });
        }
        // đảm bảo tăng dần theo thời gian
        return out.sort((a, b) => a.time - b.time);
      }

      // ===== START =====
      window.addEventListener("DOMContentLoaded", () => {
        showLine();
      });
    </script>
  </body>
</html>
